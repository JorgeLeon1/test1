<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Allocate Orders</title>
  <style>
    :root { --green:#10b981; --blue:#3b82f6; --gray:#6b7280; --bg:#f9fafb; --card:#fff; --line:#e5e7eb; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; margin:20px; background:var(--bg); color:#111827;}
    h2{margin:0 0 12px; color:#065f46}
    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;margin:10px 0 16px}
    button{background:var(--green);color:#fff;border:0;border-radius:8px;padding:10px 14px;font-weight:600;cursor:pointer}
    button.secondary{background:var(--blue)}
    button.warn{background:var(--gray)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .row{display:flex;gap:18px;align-items:flex-start}
    .left,.right{flex:1 1 0}
    .card{background:var(--card);border:1px solid var(--line);border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .card h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-size:16px}
    .card .body{padding:12px 14px}
    .search{display:flex;gap:8px}
    .search input{flex:1 1 0;padding:10px 12px;border:1px solid var(--line);border-radius:8px}
    .orders{max-height:60vh;overflow:auto}
    .order{border-bottom:1px solid var(--line)}
    .order-header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;cursor:pointer}
    .order-header:hover{background:#f3f4f6}
    .meta{font-size:12px;color:#4b5563}
    .pill{background:#ecfeff;color:#0369a1;border:1px solid #bae6fd;padding:2px 8px;border-radius:999px;font-size:12px}
    .lines{display:none}
    table{width:100%;border-collapse:collapse}
    th,td{border-top:1px solid var(--line);padding:8px 10px;text-align:left}
    th{background:#f8fafc;font-size:12px;color:#374151}
    .right .body{padding:0}
    .footer{display:flex;gap:8px;align-items:center;justify-content:flex-end;padding:12px;border-top:1px solid var(--line)}
    .muted{font-size:12px;color:#6b7280}
    #out{white-space:pre-wrap;background:#fff;border:1px solid var(--line);padding:10px;border-radius:8px;margin-top:12px;display:none}
    .spinner{display:none;position:fixed;inset:0;backdrop-filter:blur(1px);align-items:center;justify-content:center;z-index:50}
    .spinner > div{width:54px;height:54px;border:6px solid #d1d5db;border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>

  <h2>Allocate Orders</h2>

  <div class="toolbar">
    <button class="secondary" id="btnImport">Import from Extensiv</button>
    <button id="btnRunSql">Run SQL Allocation (all)</button>
    <button class="warn" id="btnPush">Push to Extensiv</button>
  </div>

  <div class="row">
    <!-- LEFT: Orders & search -->
    <div class="left card">
      <h3>Orders</h3>
      <div class="body">
        <div class="search">
          <input id="q" placeholder="Search by Order ID, Customer, or SKUâ€¦"/>
          <button class="secondary" id="btnRefresh">Refresh</button>
        </div>

        <div class="orders" id="orders"></div>
        <div class="muted" id="emptyMsg" style="display:none;padding:8px 0;">No orders found.</div>
      </div>
    </div>

    <!-- RIGHT: Lines for chosen order -->
    <div class="right card">
      <h3 id="panelTitle">Lines</h3>
      <div class="body">
        <table>
          <thead>
            <tr>
              <th style="width:42px;">
                <input type="checkbox" id="chkAll" disabled />
              </th>
              <th>SKU</th>
              <th>Qty</th>
              <th>Qualifier</th>
            </tr>
          </thead>
          <tbody id="linesTbody">
            <tr><td colspan="4" class="muted" style="padding:14px;">Select an order to view lines.</td></tr>
          </tbody>
        </table>
      </div>
      <div class="footer">
        <span class="muted" id="selectionHint">0 selected</span>
        <button id="btnAllocate" disabled>Allocate Selected Order</button>
      </div>
    </div>
  </div>

  <div id="out"></div>
  <div class="spinner" id="spinner"><div></div></div>

<script>
/* ----------------------- state ----------------------- */
let RAW = [];            // flat rows from API/DB
let ORDERS = [];         // normalized [{orderId, customerName, lines:[...] }]
let FILTERED = [];       // filtered orders for UI
let selectedOrderId = null;

/* ----------------------- helpers --------------------- */
const $ = (sel, ctx=document) => ctx.querySelector(sel);
const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
const show = (el, on=true) => el.style.display = on ? '' : 'none';
const spin = (on=true) => show($('#spinner'), on);
const out = (obj, title) => { const el=$('#out'); el.textContent=(title?title+"\n":"")+JSON.stringify(obj,null,2); show(el,true); };

function normalizeRows(rows) {
  // Accepts different shapes/keys and yields nested orders w/lines
  const byOrder = new Map();
  for (const r of rows || []) {
    const OrderID      = r.OrderID ?? r.orderId ?? r.order_id ?? r.OrderId ?? r.orderid;
    const OrderItemID  = r.OrderItemID ?? r.orderItemId ?? r.order_item_id ?? r.id;
    const CustomerName = r.CustomerName ?? r.customerName ?? r.customer;
    const SKU          = r.SKU ?? r.sku ?? r.ItemID ?? r.itemId;
    const Qty          = r.OrderedQTY ?? r.qty ?? r.quantity ?? r.orderedQty;
    const Qualifier    = r.Qualifier ?? r.qualifier ?? '';

    if (!OrderID || !OrderItemID) continue;

    if (!byOrder.has(OrderID)) {
      byOrder.set(OrderID, { orderId: OrderID, customerName: CustomerName || '(Unknown Customer)', lines: [] });
    }
    byOrder.get(OrderID).lines.push({
      orderItemId: Number(OrderItemID),
      sku: String(SKU || ''),
      qty: Number(Qty || 0),
      qualifier: String(Qualifier || '')
    });
  }
  return Array.from(byOrder.values()).sort((a,b)=>String(a.orderId).localeCompare(String(b.orderId)));
}

function renderOrders(list) {
  const wrap = $('#orders');
  wrap.innerHTML = '';
  if (!list.length) { show($('#emptyMsg'), true); return; }
  show($('#emptyMsg'), false);

  for (const o of list) {
    const id = `order-${o.orderId}`;
    const el = document.createElement('div');
    el.className = 'order';

    el.innerHTML = `
      <div class="order-header" data-id="${o.orderId}">
        <div>
          <label>
            <input type="radio" name="orderPick" value="${o.orderId}" ${o.orderId==selectedOrderId?'checked':''}/>
            <strong>#${o.orderId}</strong>
          </label>
          <div class="meta">${o.customerName || ''}</div>
        </div>
        <div><span class="pill">${o.lines.length} line(s)</span></div>
      </div>
      <div class="lines" id="${id}">
        <table>
          <thead>
            <tr><th></th><th>SKU</th><th>Qty</th><th>Qualifier</th></tr>
          </thead>
          <tbody>
            ${o.lines.map(line => `
              <tr>
                <td><input type="checkbox" class="lineChk" data-oi="${line.orderItemId}" ${o.orderId==selectedOrderId?'':'disabled'}></td>
                <td>${line.sku}</td>
                <td>${line.qty}</td>
                <td>${line.qualifier || ''}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;

    // expand if selected
    const linesBox = el.querySelector('.lines');
    linesBox.style.display = (o.orderId == selectedOrderId) ? '' : 'none';

    // header click toggles + selects
    el.querySelector('.order-header').addEventListener('click', (evt) => {
      const clickedOrderId = el.querySelector('input[type="radio"]').value;
      if (selectedOrderId == clickedOrderId) {
        // just toggle expand/collapse
        linesBox.style.display = (linesBox.style.display === 'none') ? '' : 'none';
      } else {
        selectedOrderId = clickedOrderId;
        // re-render to enable checkboxes appropriately
        renderOrders(FILTERED);
        renderSelectedPanel();
      }
    });

    wrap.appendChild(el);
  }
}

function renderSelectedPanel() {
  const order = ORDERS.find(o => String(o.orderId) === String(selectedOrderId));
  $('#panelTitle').textContent = order ? `Lines for Order #${order.orderId}` : 'Lines';
  const chkAll = $('#chkAll');
  const tbody  = $('#linesTbody');

  if (!order) {
    chkAll.checked = false; chkAll.disabled = true;
    tbody.innerHTML = `<tr><td colspan="4" class="muted" style="padding:14px;">Select an order to view lines.</td></tr>`;
    $('#btnAllocate').disabled = true;
    $('#selectionHint').textContent = '0 selected';
    return;
  }

  chkAll.disabled = false;
  chkAll.checked = true;

  // mark all visible checkboxes for this order as checked by default
  const section = document.querySelector(`#order-${order.orderId}`);
  if (section) {
    $$('.lineChk', section).forEach(cb => { cb.checked = true; });
  }

  // Mirror selected section into the right table for clarity
  tbody.innerHTML = order.lines.map(line => `
    <tr>
      <td><input type="checkbox" class="mirrorChk" data-oi="${line.orderItemId}" checked></td>
      <td>${line.sku}</td>
      <td>${line.qty}</td>
      <td>${line.qualifier || ''}</td>
    </tr>
  `).join('');

  // keep left/right checkboxes in sync
  tbody.querySelectorAll('.mirrorChk').forEach(mcb => {
    mcb.addEventListener('change', () => {
      const left = document.querySelector(`.lineChk[data-oi="${mcb.dataset.oi}"]`);
      if (left) left.checked = mcb.checked;
      updateSelectionHint();
    });
  });

  chkAll.addEventListener('change', () => {
    const on = chkAll.checked;
    tbody.querySelectorAll('.mirrorChk').forEach(c => c.checked = on);
    const leftSection = document.querySelector(`#order-${order.orderId}`);
    if (leftSection) leftSection.querySelectorAll('.lineChk').forEach(c => c.checked = on);
    updateSelectionHint();
  });

  $('#btnAllocate').disabled = false;
  updateSelectionHint();
}

function currentSelectedLineIds() {
  if (!selectedOrderId) return [];
  return $$('.mirrorChk')
    .filter(cb => cb.checked)
    .map(cb => Number(cb.dataset.oi));
}

function updateSelectionHint() {
  $('#selectionHint').textContent = `${currentSelectedLineIds().length} selected`;
}

/* ----------------------- data loading ------------------ */
async function tryJson(url, options) {
  const r = await fetch(url, options);
  if (!r.ok) throw new Error(`${url} -> ${r.status}`);
  return r.json();
}

async function loadData() {
  spin(true);
  try {
    let rows = [];
    // 1) unallocated rows straight from DB
    try {
      rows = await tryJson('/api/unallocated-orders');
    } catch {}
    // 2) nested endpoint (if present)
    if (!rows?.length) {
      try {
        const nested = await tryJson('/extensiv/orders-with-lines');
        // flatten if nested came back
        if (Array.isArray(nested)) {
          for (const o of nested) {
            for (const l of (o.lines||[])) {
              rows.push({
                OrderID:o.orderId, CustomerName:o.customerName,
                OrderItemID:l.orderItemId, SKU:l.sku, OrderedQTY:l.qty, Qualifier:l.qualifier
              });
            }
          }
        }
      } catch {}
    }
    // 3) your older endpoint
    if (!rows?.length) {
      try {
        const flat = await tryJson('/getAllOrders');
        rows = Array.isArray(flat) ? flat : [];
      } catch {}
    }

    RAW = rows || [];
    ORDERS = normalizeRows(RAW);
    FILTERED = ORDERS.slice();
    renderOrders(FILTERED);
    // pick first order by default
    if (ORDERS.length && !selectedOrderId) {
      selectedOrderId = ORDERS[0].orderId;
      renderOrders(FILTERED);
    }
    renderSelectedPanel();
  } catch (e) {
    console.error(e);
    $('#orders').innerHTML = '<div class="muted" style="padding:10px;">Failed to load orders.</div>';
  } finally {
    spin(false);
  }
}

/* -------------------- actions / buttons ---------------- */
$('#btnImport').addEventListener('click', async () => {
  spin(true);
  try {
    const payload = { modifiedSince:'2025-07-01T00:00:00Z', status: 'AWAITINGPICK' };
    const res = await fetch('/extensiv/import', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
    const data = await res.json();
    out(data, 'Import result:');
    await loadData();
    alert('Import complete.');
  } catch (e) {
    console.error(e); alert('Import failed.');
  } finally { spin(false); }
});

$('#btnRunSql').addEventListener('click', async () => {
  if (!confirm('Run SQL allocation across eligible lines?')) return;
  spin(true);
  try {
    const res = await fetch('/extensiv/allocate', { method:'POST' });
    const data = await res.json();
    out(data, 'SQL allocation result:');
    await loadData();
    alert('Allocation complete.');
  } catch (e) {
    console.error(e); alert('Allocation failed.');
  } finally { spin(false); }
});

$('#btnPush').addEventListener('click', async () => {
  if (!confirm('Push SuggAlloc to Extensiv?')) return;
  spin(true);
  try {
    const res = await fetch('/extensiv/push', { method:'POST' });
    const data = await res.json();
    out(data, 'Push result:');
    alert('Push complete.');
  } catch (e) {
    console.error(e); alert('Push failed.');
  } finally { spin(false); }
});

$('#btnRefresh').addEventListener('click', loadData);

$('#btnAllocate').addEventListener('click', async () => {
  const ids = currentSelectedLineIds();
  if (!selectedOrderId) return alert('Pick an order first.');
  if (!ids.length) return alert('Select at least one line to allocate.');

  spin(true);
  try {
    // Your existing endpoint expects { lineIds: [...] }
    const r = await fetch('/allocateOrders', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ lineIds: ids })
    });
    if (!r.ok) throw new Error('Server error');
    const data = await r.json();
    out(data, 'Allocate selected order result:');
    await loadData();
    alert('Allocation complete for selected order.');
  } catch (e) {
    console.error(e); alert('Allocation failed.');
  } finally { spin(false); }
});

$('#q').addEventListener('input', () => {
  const q = $('#q').value.trim().toLowerCase();
  if (!q) {
    FILTERED = ORDERS.slice();
  } else {
    FILTERED = ORDERS.filter(o => {
      const inHeader = String(o.orderId).toLowerCase().includes(q) ||
                       String(o.customerName||'').toLowerCase().includes(q);
      const inLines  = o.lines.some(l =>
        String(l.sku||'').toLowerCase().includes(q) ||
        String(l.qty||'').toLowerCase().includes(q) ||
        String(l.orderItemId||'').toLowerCase().includes(q)
      );
      return inHeader || inLines;
    });
  }
  renderOrders(FILTERED);
  // keep right panel if current order is still visible; else reset
  if (!FILTERED.some(o => String(o.orderId) === String(selectedOrderId))) {
    selectedOrderId = FILTERED[0]?.orderId || null;
  }
  renderSelectedPanel();
});

/* -------------------- boot -------------------- */
loadData();
</script>
</body>
</html>
