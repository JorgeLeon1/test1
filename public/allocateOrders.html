<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order Lines</title>
  <style>
    body { font-family: sans-serif; background:#f9fafb; margin:2rem; }
    h2  { margin-bottom:1rem; font-size:1.8rem; color:#00796b; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .toolbar { display:flex; gap:.5rem; margin:.75rem 0 1.25rem; flex-wrap:wrap; }
    button { background:#10b981; color:#fff; padding:.6rem 1rem; border:none; border-radius:6px; font-size:1rem; cursor:pointer; transition:background-color .2s ease; }
    button.secondary { background:#3b82f6; }
    button.warn { background:#6b7280; }
    button:hover { filter:brightness(0.95); }
    table { width:100%; border-collapse:collapse; margin-bottom:2rem; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,.05); }
    thead { background:#e5e7eb; }
    th, td { padding:.45rem 1rem; border-bottom:1px solid #e5e7eb; text-align:left; font-size:11pt; }
    tr.group-header { background:#f3f4f6; font-weight:bold; }
    tr:hover td { background:#f0fdf4; }
    input[type="checkbox"] { transform:scale(1.2); }
    .loading { font-style:italic; color:#6b7280; }
    .spinner { border:8px solid #5c6bc0; border-top:8px solid #3498db; border-radius:50%; width:60px; height:60px; animation:spin 1s linear infinite; }
    #loadingSpinner { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1000; display:none; }
    #out { white-space:pre-wrap; background:#fff; border:1px solid #e5e7eb; padding:.75rem; border-radius:6px; margin:.75rem 0; font-size:.95rem; color:#111827; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  </style>
</head>
<body>

  <h2>Select Order Lines To Allocate</h2>

  <div class="toolbar">
    <!-- NEW: Extensiv workflow buttons -->
    <button class="secondary" onclick="importFromExtensiv()">Import from Extensiv</button>
    <button onclick="runSqlAllocation()">Run SQL Allocation</button>
    <button class="warn" onclick="pushToExtensiv()">Push to Extensiv</button>

    <!-- Your existing flow -->
    <button onclick="allocateOrderLines()">Allocate Selected Lines (legacy)</button>
    <button class="secondary" id="toggle-orders-btn" onclick="toggleOrdersContainer()" style="display:none;">Show Orders</button>
    <button class="warn" onclick="alert('coming soon! Choose batch by PO, destination, etc.')">Define a batch</button>
    <button class="warn" onclick="alert('coming soon! Consolidate partial pallets')">Consolidate</button>
  </div>

  <div id="out" style="display:none;"></div>

  <div id="orders-container">
    <p class="loading">Loading orders...</p>
  </div>

  <div id="visualization-container" style="margin-top: 2rem;"></div>

  <div id="loadingSpinner"><div class="spinner"></div></div>

  <script>
    // ---------- Helpers ----------
    const spinnerEl = document.getElementById('loadingSpinner');
    const outEl = document.getElementById('out');
    function showSpinner(show=true){ spinnerEl.style.display = show ? 'block' : 'none'; }
    function showOut(obj, title){
      outEl.style.display = 'block';
      outEl.textContent = (title ? title + "\n" : "") + JSON.stringify(obj, null, 2);
    }
    const api = (path, method='POST', body=null) =>
      fetch(path, {
        method,
        headers: { 'Content-Type':'application/json' },
        body: body ? JSON.stringify(body) : null
      }).then(r => r.json());

    // ---------- NEW: Extensiv workflow ----------
    async function importFromExtensiv() {
      try {
        showSpinner(true);
        const data = await api('/extensiv/import', 'POST', {
          modifiedSince: '2025-07-01T00:00:00Z',
          status: 'AWAITINGPICK'
        });
        showOut(data, 'Import result:');
        alert('Import complete. Check console/output box.');
        console.log('[import]', data);
      } catch (e) {
        console.error(e); alert('Import failed');
      } finally { showSpinner(false); }
    }

    async function runSqlAllocation() {
      try {
        showSpinner(true);
        const data = await api('/extensiv/allocate', 'POST');
        showOut(data, 'SQL allocation result:');
        alert('Allocation complete. Check console/output box.');
        console.log('[allocate]', data);
      } catch (e) {
        console.error(e); alert('Allocation failed');
      } finally { showSpinner(false); }
    }

    async function pushToExtensiv() {
      if (!confirm('Push SuggAlloc to Extensiv?')) return;
      try {
        showSpinner(true);
        const data = await api('/extensiv/push', 'POST');
        showOut(data, 'Push result:');
        alert('Push complete. Check console/output box.');
        console.log('[push]', data);
      } catch (e) {
        console.error(e); alert('Push failed');
      } finally { showSpinner(false); }
    }

    // ---------- Your existing grouping/table ----------
    function groupByOrder(data) {
      return data.reduce((acc, line) => {
        const key = `${line.order_id} | ${line.customerName}`;
        (acc[key] ||= []).push(line);
        return acc;
      }, {});
    }

    function renderTable(groupedData) {
      const container = document.getElementById('orders-container');
      container.innerHTML = '';
      for (const groupKey in groupedData) {
        const [orderNumber, customer] = groupKey.split(' | ');
        const lines = groupedData[groupKey];
        const groupId = `group-${orderNumber}`;

        const tableWrapper = document.createElement('div');
        tableWrapper.classList.add('table-wrapper');
        tableWrapper.dataset.group = groupId;

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr class="group-header">
            <td colspan="5">
              <label>
                <input type="checkbox" class="toggle-group" data-group="${groupId}" checked />
                <strong>Order #${orderNumber} â€“ ${customer}</strong>
              </label>
              &nbsp;&nbsp;&nbsp;
              <label style="font-weight: normal; font-size: .9em;">
                <input type="checkbox" class="select-all-group" data-group="${groupId}" />
                Select All
              </label>
            </td>
          </tr>
          <tr>
            <th style="padding:4px;"></th>
            <th style="padding:4px;">SKU</th>
            <th style="padding:4px;">Quantity</th>
          </tr>
        `;

        const tbody = document.createElement('tbody');
        tbody.classList.add('group-lines');
        tbody.dataset.group = groupId;

        for (const line of lines) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td style="padding:4px;"><input type="checkbox" class="select-line" data-id="${line.order_id}" data-group="${groupId}" /></td>
            <td style="padding:4px;">${line.sku}</td>
            <td style="padding:4px;">${line.qty}</td>
          `;
          tbody.appendChild(row);
        }

        table.appendChild(thead);
        table.appendChild(tbody);
        tableWrapper.appendChild(table);
        container.appendChild(tableWrapper);
      }

      // Collapse/expand groups
      document.querySelectorAll('.toggle-group').forEach(cb => {
        cb.addEventListener('change', (e) => {
          const group = e.target.dataset.group;
          const rows = document.querySelectorAll(`tbody[data-group="${group}"]`);
          rows.forEach(row => row.style.display = e.target.checked ? '' : 'none');
        });
      });

      // Select all in group
      document.querySelectorAll('.select-all-group').forEach(cb => {
        cb.addEventListener('change', (e) => {
          const group = e.target.dataset.group;
          document.querySelectorAll(`.select-line[data-group="${group}"]`)
            .forEach(c => c.checked = e.target.checked);
        });
      });
    }

    function toggleOrdersContainer() {
      const ordersContainer = document.getElementById('orders-container');
      const toggleBtn = document.getElementById('toggle-orders-btn');
      const hidden = ordersContainer.style.display === 'none';
      ordersContainer.style.display = hidden ? 'block' : 'none';
      toggleBtn.textContent = hidden ? 'Hide Orders' : 'Show Orders';
    }

    // ---------- Your legacy allocation button ----------
    async function allocateOrderLines() {
      const selected = Array.from(document.querySelectorAll('.select-line:checked'));
      const selectedIds = selected.map(cb => cb.dataset.id);
      if (!selectedIds.length) return alert('Please select at least one order line to allocate.');

      // Hide list, show toggle
      document.getElementById('orders-container').style.display = 'none';
      document.getElementById('toggle-orders-btn').style.display = 'inline-block';

      try {
        showSpinner(true);
        const res = await fetch('/allocateOrders', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ lineIds: selectedIds })
        });
        showSpinner(false);
        if (!res.ok) throw new Error('Server error');
        const data = await res.json();
        alert('Allocations (legacy):\n' + JSON.stringify(data));
        loadVisualization();
      } catch (err) {
        console.error(err); alert('Failed to allocate order lines.');
      } finally { showSpinner(false); }
    }

    function loadVisualization() {
      fetch('visualizeLocations.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('visualization-container').innerHTML = html;
          const scripts = document.getElementById('visualization-container').querySelectorAll("script");
          scripts.forEach(oldScript => {
            const s = document.createElement("script");
            if (oldScript.src) s.src = oldScript.src; else s.textContent = oldScript.textContent;
            document.body.appendChild(s);
          });
        })
        .catch(err => {
          console.error('Failed to load visualization:', err);
          alert('Could not load allocation visualization.');
        });
    }

    // ---------- Init ----------
    fetch('/getAllOrders')
      .then(r => r.json())
      .then(data => {
        alert('Note: TEST orders. Allocations will not be posted to Extensiv during tests.');
        const grouped = groupByOrder(data);
        renderTable(grouped);
      })
      .catch(err => {
        document.getElementById('orders-container').innerHTML = '<p>Error loading orders.</p>';
        console.error(err);
      });
  </script>
</body>
</html>
