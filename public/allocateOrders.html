<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Allocate Orders</title>
  <style>
    :root{--brand:#10b981;--brand2:#3b82f6;--muted:#6b7280;--bg:#f5f7fb;--card:#fff;--line:#e5e7eb}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{padding:18px 22px} h1{margin:0;font-size:22px;color:#0f766e}
    .bar{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    button{border:0;border-radius:8px;padding:10px 14px;font-weight:600;color:#fff;cursor:pointer}
    .pri{background:var(--brand)} .sec{background:var(--brand2)} .ghost{background:#4b5563}
    .wrap{display:grid;grid-template-columns:1fr 1.2fr;gap:18px;padding:0 22px 22px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 6px 24px rgba(16,24,40,.04);overflow:hidden;border:1px solid var(--line)}
    .card h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--line);font-size:16px}
    .pad{padding:12px}
    .row{display:flex;gap:10px;align-items:center}
    input[type="search"]{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:8px;font-size:14px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    tbody tr:hover{background:#f0fdf4}
    .orders{max-height:62vh;overflow:auto}
    .lines{max-height:62vh;overflow:auto}
    .muted{color:#6b7280} .right{display:flex;justify-content:flex-end;align-items:center;gap:12px;padding:10px 12px}
    .pill{padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
    .empty{padding:16px;color:#6b7280}
    .spinner{width:24px;height:24px;border-radius:50%;border:4px solid #e5e7eb;border-top-color:#60a5fa;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hidden{display:none}
  </style>
</head>
<body>

<header>
  <h1>Allocate Orders</h1>
  <div class="bar">
    <button class="sec"  id="btnImport">Import from Extensiv</button>
    <button class="pri"  id="btnSqlAllocAll">Run SQL Allocation (all)</button>
    <button class="ghost" id="btnPush">Push to Extensiv</button>
  </div>
</header>

<main class="wrap">
  <!-- Orders -->
  <section class="card">
    <h3>Orders</h3>
    <div class="pad row">
      <input id="search" type="search" placeholder="Search by Order ID, Customer, or SKUâ€¦"/>
      <button class="sec" id="btnRefresh">Refresh</button>
    </div>
    <div class="orders" id="ordersBox">
      <div class="empty" id="ordersEmpty">No orders found.</div>
      <table id="ordersTable" class="hidden">
        <thead>
          <tr><th>Order</th><th>Customer</th><th class="muted">Open Lines</th></tr>
        </thead>
        <tbody id="ordersTbody"></tbody>
      </table>
    </div>
  </section>

  <!-- Lines -->
  <section class="card">
    <h3>Lines</h3>
    <div class="lines">
      <table>
        <thead>
          <tr><th style="width:40px"><input type="checkbox" id="chkAll"/></th><th>SKU</th><th>Qty</th><th>Qualifier</th></tr>
        </thead>
        <tbody id="linesTbody">
          <tr><td colspan="4" class="empty">Select an order to view lines.</td></tr>
        </tbody>
      </table>
    </div>
    <div class="right">
      <span class="muted"><span id="selCount">0</span> selected</span>
      <button class="pri" id="btnAllocate">Allocate Selected Order</button>
    </div>
  </section>
</main>

<!-- Toast / small output area -->
<div id="toast" class="hidden" style="position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:8px;font-size:13px;"></div>

<script>
/* ------------------ helpers ------------------ */
const $ = (sel) => document.querySelector(sel);
const show = (el, on=true)=> el.classList.toggle('hidden', !on);
let ORDERS = [];        // [{orderId, customerName, lines:[{orderItemId, sku, qty, qualifier}]}]
let FILTERED = [];      // filtered view
let currentOrderId = null;

function toast(msg, ms=2200){
  const t = $('#toast'); t.textContent = msg; show(t,true);
  setTimeout(()=>show(t,false), ms);
}

async function jget(url){
  const r = await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json();
}
async function jpost(url, body){
  const r = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})});
  if(!r.ok) throw new Error(await r.text()); return r.json();
}

/* ------------- data loaders ------------- */
async function loadOrders(){
  // Try nested endpoint first
  try{
    const data = await jget('/extensiv/orders-with-lines');
    if(Array.isArray(data) && data.length){ ORDERS = data; FILTERED = data; renderOrders(); return; }
  }catch(e){ console.warn('orders-with-lines:', e.message); }

  // Fallback: flat list -> group in browser
  try{
    const flat = await jget('/api/unallocated-orders');
    if(Array.isArray(flat) && flat.length){
      const by = new Map();
      for(const r of flat){
        if(!by.has(r.OrderID)) by.set(r.OrderID,{orderId:r.OrderID,customerName:r.CustomerName||'',lines:[]});
        by.get(r.OrderID).lines.push({orderItemId:r.OrderItemID,sku:r.SKU,qty:r.OrderedQTY,qualifier:r.Qualifier||''});
      }
      ORDERS = Array.from(by.values()); FILTERED = ORDERS; renderOrders(); return;
    }
  }catch(e){ console.warn('unallocated-orders:', e.message); }

  // Last fallback (legacy)
  try{
    const legacy = await jget('/getAllOrders');
    const by = new Map();
    for(const r of legacy||[]){
      if(!by.has(r.order_id)) by.set(r.order_id,{orderId:r.order_id,customerName:r.customerName||'',lines:[]});
      by.get(r.order_id).lines.push({orderItemId:r.id,sku:r.sku,qty:r.qty,qualifier:r.qualifier||''});
    }
    ORDERS = Array.from(by.values()); FILTERED = ORDERS; renderOrders(); return;
  }catch(e){ console.warn('getAllOrders:', e.message); }

  ORDERS = []; FILTERED = []; renderOrders();
}

/* ------------- renderers ------------- */
function renderOrders(){
  const tbody = $('#ordersTbody');
  tbody.innerHTML = '';
  if(!FILTERED.length){
    show($('#ordersTable'), false);
    $('#ordersEmpty').textContent = 'No orders found.';
    show($('#ordersEmpty'), true);
    renderLines(null);
    return;
  }
  show($('#ordersEmpty'), false);
  show($('#ordersTable'), true);

  for(const o of FILTERED){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>#${o.orderId}</strong></td>
      <td>${o.customerName||''}</td>
      <td><span class="pill">${o.lines.length}</span></td>`;
    tr.style.cursor='pointer';
    tr.addEventListener('click', ()=> selectOrder(o.orderId));
    tbody.appendChild(tr);
  }
  // keep current selection visible if exists
  if(currentOrderId){ selectOrder(currentOrderId, true); }
}

function selectOrder(orderId, silent=false){
  currentOrderId = orderId;
  const order = ORDERS.find(o=>o.orderId===orderId) || FILTERED.find(o=>o.orderId===orderId);
  renderLines(order);
  if(!silent) toast(`Order #${orderId} selected`);
}

function renderLines(order){
  const tb = $('#linesTbody'); tb.innerHTML = '';
  $('#chkAll').checked = false; $('#selCount').textContent = '0';

  if(!order){
    tb.innerHTML = `<tr><td colspan="4" class="empty">Select an order to view lines.</td></tr>`;
    return;
  }
  for(const ln of order.lines){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" class="lineChk" data-id="${ln.orderItemId}"/></td>
      <td>${ln.sku}</td>
      <td>${ln.qty}</td>
      <td>${ln.qualifier||''}</td>`;
    tb.appendChild(tr);
  }
}

/* ------------- interactions ------------- */
$('#chkAll').addEventListener('change', (e)=>{
  document.querySelectorAll('.lineChk').forEach(c=> c.checked = e.target.checked);
  updateSelCount();
});
document.addEventListener('change', (e)=>{
  if(e.target.classList.contains('lineChk')) updateSelCount();
});
function updateSelCount(){
  const n = [...document.querySelectorAll('.lineChk:checked')].length;
  $('#selCount').textContent = String(n);
}

$('#btnAllocate').addEventListener('click', async ()=>{
  const ids = [...document.querySelectorAll('.lineChk:checked')].map(c=>Number(c.dataset.id));
  if(!currentOrderId){ return alert('Select an order first.'); }
  if(!ids.length){ return alert('Select at least one line.'); }
  try{
    await jpost('/allocateOrders', { lineIds: ids });
    toast('Allocation complete');
    // refresh the data to reflect reduced open qty
    await loadOrders();
    // reselect the same order if still present
    if(ORDERS.some(o=>o.orderId===currentOrderId)) selectOrder(currentOrderId);
    else renderLines(null);
  }catch(e){
    console.error(e); alert('Allocation failed: ' + e.message);
  }
});

$('#btnImport').addEventListener('click', async ()=>{
  try{
    const r = await jpost('/extensiv/import', { status:'AWAITINGPICK' });
    toast(`Import complete: ${r.upsertedItems ?? 0} lines`);
    await loadOrders();
  }catch(e){ console.error(e); alert('Import failed: ' + e.message); }
});

$('#btnSqlAllocAll').addEventListener('click', async ()=>{
  try{
    const r = await jpost('/extensiv/allocate', {});
    toast('SQL allocation finished');
    await loadOrders();
  }catch(e){ console.error(e); alert('SQL allocation failed: ' + e.message); }
});

$('#btnPush').addEventListener('click', async ()=>{
  if(!confirm('Push current SuggAlloc to Extensiv?')) return;
  try{
    const r = await jpost('/extensiv/push', {});
    toast('Push complete');
  }catch(e){ console.error(e); alert('Push failed: ' + e.message); }
});

$('#btnRefresh').addEventListener('click', loadOrders);

$('#search').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  if(!q){ FILTERED = ORDERS; renderOrders(); return; }
  FILTERED = ORDERS
    .map(o => ({
      ...o,
      lines: o.lines.filter(l =>
        (l.sku||'').toLowerCase().includes(q) ||
        String(o.orderId).includes(q) ||
        (o.customerName||'').toLowerCase().includes(q)
      )
    }))
    .filter(o => String(o.orderId).includes(q) ||
                 (o.customerName||'').toLowerCase().includes(q) ||
                 o.lines.length);
  renderOrders();
});

/* ------------- boot ------------- */
loadOrders();
</script>
</body>
</html>
